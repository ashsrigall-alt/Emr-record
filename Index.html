<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>SHREE RAM CLINIC – EMR (FINAL)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{--brand:#083d77;--muted:#f0f3f6}
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--muted)}
header{background:var(--brand);color:#fff;padding:14px;text-align:center}
.container{max-width:1100px;margin:14px auto;padding:12px}
.card{background:#fff;border-radius:8px;padding:14px;margin-bottom:14px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
label{font-weight:700;margin-top:8px;display:block}
input,select{width:100%;padding:8px;margin-top:4px;border:1px solid #ccc;border-radius:4px}
.flex{display:flex;gap:10px;flex-wrap:wrap}
.flex>div{flex:1;min-width:150px}
button{background:var(--brand);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
button.secondary{background:#555}
ul{padding-left:18px}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #bbb;padding:6px;font-size:13px}
th{background:#eef3f7}
.no-print{margin-bottom:10px}
@media print{.no-print{display:none}}
.muted{font-size:12px;color:#555}
</style>
</head>

<body>
<header>
  <div style="font-size:18px;font-weight:700">SHREE RAM CLINIC</div>
  <div style="font-size:13px">ADDRESS – BIRRA, CHAMPA · General Medicine</div>
</header>

<div class="container">

<!-- ================= ADD VISIT ================= -->
<div class="card">
<h3>Add Patient Visit</h3>

<div class="flex">
  <div><label>Name</label><input id="name"></div>
  <div><label>Mobile</label><input id="mobile"></div>
</div>

<label>Address</label>
<input id="address">

<div class="flex">
  <div><label>Age</label><input id="age" type="number"></div>
  <div><label>Gender</label>
    <select id="gender"><option>Male</option><option>Female</option></select>
  </div>
</div>

<label>Diagnosis</label>
<input id="diagnosis" placeholder="Primary / provisional diagnosis">

<label>Follow-up Date</label>
<input id="followup" type="date">

<hr>

<h4>Add Medicine</h4>

<div class="flex">
  <div><label>Medicine</label><select id="medicine"></select></div>
  <div><label>Custom Drug</label><input id="customDrug"></div>
</div>

<label>Dose / Instructions</label>
<input id="dose" placeholder="after food / before food">

<div class="flex">
  <button class="secondary" onclick="setPattern('1-0-1')">1-0-1</button>
  <button class="secondary" onclick="setPattern('1-1-1')">1-1-1</button>
  <button class="secondary" onclick="setPattern('1-0-0')">1-0-0</button>
  <button class="secondary" onclick="setPattern('0-0-1')">0-0-1</button>
</div>

<label>Duration</label>
<input id="duration" placeholder="5 days / 2 weeks">

<div class="flex">
  <select id="preset">
    <option value="">Preset</option>
    <option>OD</option><option>BD</option><option>TDS</option>
    <option>HS</option><option>SOS</option>
  </select>
  <button class="secondary" onclick="applyPreset()">Apply</button>
</div>

<button onclick="addMedicine()">Add Medicine</button>
<ul id="rxList"></ul>

<button onclick="saveRecord()">Save Visit</button>
<button class="secondary" onclick="exportCSV()">Export CSV</button>
</div>

<!-- ================= RECORDS ================= -->
<div class="card">
<h3>Patient Records</h3>
<div class="no-print">
  <button class="secondary" onclick="setLang('en')">English</button>
  <button class="secondary" onclick="setLang('hi')">हिंदी</button>
</div>

<table>
<thead>
<tr><th>UHID</th><th>OPD</th><th>Date</th><th>Name</th><th>Diagnosis</th><th>Print</th></tr>
</thead>
<tbody id="records"></tbody>
</table>
</div>

</div>

<script>
const $=id=>document.getElementById(id);
let PRINT_LANG='en';
let rx=[];

const meds=["Paracetamol","Pantoprazole","Amoxiclav","Azithromycin","Amlodipine","Metformin"];

function setLang(l){PRINT_LANG=l;alert("Print language set");}

function loadMeds(){
  meds.forEach(m=>{let o=document.createElement('option');o.textContent=m;$('medicine').appendChild(o);});
}
loadMeds();

function setPattern(p){$('dose').value=($('dose').value+' '+p).trim();}
function applyPreset(){if($('preset').value)$('dose').value+=' '+$('preset').value;}

function addMedicine(){
  const drug=$('customDrug').value||$('medicine').value;
  const dose=$('dose').value;
  const dur=$('duration').value||'NA';
  if(!drug||!dose)return alert("Enter drug & dose");
  rx.push(`${drug}|${dose}|${dur}`);
  $('dose').value='';$('duration').value='';$('customDrug').value='';
  renderRx();
}

function renderRx(){
  $('rxList').innerHTML='';
  rx.forEach(x=>{
    const p=x.split('|');
    const li=document.createElement('li');
    li.innerHTML=`<b>${p[0]}</b> – ${p[1]} <span class="muted">(${p[2]})</span>`;
    $('rxList').appendChild(li);
  });
}

function getUHID(m){
  let map=JSON.parse(localStorage.getItem('uhid')||'{}');
  if(!map[m]){map[m]='UH'+(1000+Object.keys(map).length);localStorage.setItem('uhid',JSON.stringify(map));}
  return map[m];
}

function saveRecord(){
  const data=JSON.parse(localStorage.getItem('emr')||'[]');
  data.push({
    uhid:getUHID($('mobile').value),
    opd:data.length+1,
    date:new Date().toLocaleString(),
    name:$('name').value,
    mobile:$('mobile').value,
    dx:$('diagnosis').value,
    rx:rx.join('||'),
    fu:$('followup').value
  });
  localStorage.setItem('emr',JSON.stringify(data));
  rx=[];renderRx();loadRecords();alert("Saved");
}

function translateHi(t){
  return t.replace("1-0-1","सुबह-शाम").replace("1-1-1","सुबह-दोपहर-शाम")
          .replace("after food","भोजन के बाद").replace("before food","भोजन से पहले");
}

function loadRecords(){
  const data=JSON.parse(localStorage.getItem('emr')||'[]');
  $('records').innerHTML='';
  data.forEach((r,i)=>{
    let tr=$('records').insertRow();
    tr.innerHTML=`<td>${r.uhid}</td><td>${r.opd}</td><td>${r.date}</td>
    <td>${r.name}</td><td>${r.dx}</td>
    <td><button onclick="printRec(${i})">Print</button></td>`;
  });
}

function printRec(i){
  const r=JSON.parse(localStorage.getItem('emr'))[i];

  const rxText=r.rx.split('||').map((x,j)=>{
    const p=x.split('|');
    return `${j+1}. ${p[0]} – ${p[1]} (${p[2]})`;
  }).join('\n');

  const qrData=encodeURIComponent(
`UHID: ${r.uhid}
Name: ${r.name}
Mobile: ${r.mobile}
Date: ${r.date}

Diagnosis:
${r.dx}

Treatment:
${rxText}

Follow-up:
${r.fu||'Not specified'}`
  );

  const rxHtml=r.rx.split('||').map((x,j)=>{
    const p=x.split('|');
    let d=PRINT_LANG==='hi'?translateHi(p[1]):p[1];
    return `${j+1}. <b>${p[0]}</b><br>
            <span class="muted">Dose: ${d}</span><br>
            <span class="muted">Duration: ${p[2]}</span>`;
  }).join('<br><br>');

  const w=window.open();
  w.document.write(`
  <h3>SHREE RAM CLINIC</h3>
  <img src="https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=${qrData}">
  <p><b>Name:</b> ${r.name}<br><b>Diagnosis:</b> ${r.dx}</p><hr>
  ${rxHtml}<br><br>
  <b>Follow-up:</b> ${r.fu||'-'}<br><br>
  <b>Dr. Ashwini Srivastav</b>
  `);
  w.print();
}

loadRecords();
</script>
</body>
  </html>
