<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>SHREE RAM CLINIC â€“ EMR (FINAL)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
:root{--brand:#083d77;--muted:#f0f3f6}
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--muted)}
header{background:var(--brand);color:#fff;padding:14px;text-align:center}
.container{max-width:1100px;margin:14px auto;padding:12px}
.card{background:#fff;border-radius:8px;padding:14px;margin-bottom:14px}
label{font-weight:700;margin-top:8px;display:block}
input{width:100%;padding:8px;margin-top:4px}
.flex{display:flex;gap:10px;flex-wrap:wrap}
.flex>div{flex:1;min-width:150px}
button{background:var(--brand);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
button.secondary{background:#555}
ul{padding-left:18px}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #bbb;padding:6px;font-size:13px}
th{background:#eef3f7}
.muted{font-size:12px;color:#555}
#loginBox{max-width:320px;margin:120px auto;background:#fff;padding:20px;border-radius:8px}
.hidden{display:none}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginBox">
  <h3>Clinic Login</h3>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
</div>

<div id="app" class="hidden">

<header>
  <div style="font-size:18px;font-weight:700">SHREE RAM CLINIC</div>
  <div style="font-size:13px">ADDRESS â€“ BIRRA, CHAMPA Â· General Medicine</div>
</header>

<div class="container">

<div class="card">
<h3>Add Patient Visit</h3>

<div class="flex">
  <div><label>Name</label><input id="name"></div>
  <div><label>Mobile</label><input id="mobile"></div>
</div>

<label>Diagnosis</label>
<input id="diagnosis">

<label>Follow-up Date</label>
<input id="followup" type="date">

<hr>

<h4>Add Medicine</h4>

<label>Drug</label>
<input id="drug">

<label>Dose</label>
<input id="dose">

<div class="flex">
  <button class="secondary" onclick="setPattern('1-0-1')">1-0-1</button>
  <button class="secondary" onclick="setPattern('1-1-1')">1-1-1</button>
  <button class="secondary" onclick="setPattern('1-0-0')">1-0-0</button>
  <button class="secondary" onclick="setPattern('0-0-1')">0-0-1</button>
</div>

<label>Duration</label>
<input id="duration" placeholder="5 days / 2 weeks">

<button onclick="addMedicine()">Add Medicine</button>
<ul id="rxList"></ul>

<button onclick="saveRecord()">Save Visit</button>
</div>

<div class="card">
<h3>Patient Records</h3>
<table>
<thead>
<tr><th>UHID</th><th>Date</th><th>Name</th><th>Diagnosis</th><th>Print</th></tr>
</thead>
<tbody id="records"></tbody>
</table>
</div>

</div>
</div>

<script>
/* ðŸ”´ PASTE YOUR REAL FIREBASE CONFIG HERE */
const firebaseConfig = {
  apiKey: "YOUR_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT.firebaseio.com",
  projectId: "YOUR_PROJECT"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* LOGIN */
function login(){
  firebase.auth().signInWithEmailAndPassword(email.value,password.value)
    .then(()=>{
      loginBox.classList.add("hidden");
      app.classList.remove("hidden");
      loadRecords();
    })
    .catch(e=>alert(e.message));
}

/* EMR LOGIC */
let rx=[];

function setPattern(p){
  dose.value = (dose.value + " " + p).trim();
}

function addMedicine(){
  if(!drug.value||!dose.value)return alert("Enter drug & dose");
  rx.push(`${drug.value}|${dose.value}|${duration.value||'NA'}`);
  drug.value='';dose.value='';duration.value='';
  renderRx();
}

function renderRx(){
  rxList.innerHTML='';
  rx.forEach(x=>{
    const p=x.split('|');
    const li=document.createElement('li');
    li.innerHTML=`<b>${p[0]}</b> â€“ ${p[1]} <span class="muted">(${p[2]})</span>`;
    rxList.appendChild(li);
  });
}

function getUHID(m){
  return "UH"+m.slice(-6);
}

function saveRecord(){
  const record={
    uhid:getUHID(mobile.value),
    date:new Date().toLocaleString(),
    name:name.value,
    mobile:mobile.value,
    dx:diagnosis.value,
    rx:rx,
    fu:followup.value
  };
  db.ref("records").push(record);
  rx=[];renderRx();alert("Saved");
}

function loadRecords(){
  db.ref("records").on("value",snap=>{
    records.innerHTML='';
    const data=snap.val();
    if(!data)return;
    Object.values(data).forEach(r=>{
      let tr=records.insertRow();
      tr.innerHTML=`
        <td>${r.uhid}</td>
        <td>${r.date}</td>
        <td>${r.name}</td>
        <td>${r.dx}</td>
        <td><button onclick='printRec(${JSON.stringify(r)})'>Print</button></td>
      `;
    });
  });
}

/* ---------- FINAL A4 PRINT ---------- */
function printRec(r){

  const rxHTML = r.rx.map((x,i)=>{
    const p = x.split('|');
    return `
      <tr>
        <td style="width:5%">${i+1}.</td>
        <td>
          <b>${p[0]}</b><br>
          Dose: ${p[1]}<br>
          Duration: ${p[2]}
        </td>
      </tr>`;
  }).join('');

  const rxQR = r.rx.map((x,i)=>{
    const p=x.split('|');
    return `${i+1}. ${p[0]} â€“ ${p[1]} (${p[2]})`;
  }).join('\n');

  const qrData = encodeURIComponent(
`UHID: ${r.uhid}
Name: ${r.name}
Diagnosis: ${r.dx}

Treatment:
${rxQR}

Follow-up: ${r.fu || '-'}`
  );

  const html = `
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>
@page{size:A4;margin:15mm}
body{font-family:Arial;font-size:13px}
.header{text-align:center;font-weight:700;font-size:17px}
.sub{text-align:center;font-size:12px}
.line{border-top:1px solid #000;margin:10px 0}
table{width:100%;border-collapse:collapse}
td{padding:4px;vertical-align:top}
.footer{text-align:right;margin-top:30px;font-weight:700}
</style>
</head>
<body>

<div class="header">SHREE RAM CLINIC</div>
<div class="sub">ADDRESS â€“ BIRRA, CHAMPA<br>General Medicine</div>

<table>
<tr>
<td>
<b>Name:</b> ${r.name}<br>
<b>Diagnosis:</b> ${r.dx}
</td>
<td style="text-align:right">
<img src="https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=${qrData}">
</td>
</tr>
</table>

<div class="line"></div>

<b>Rx</b>
<table>${rxHTML}</table>

<div class="line"></div>

<b>Follow-up:</b> ${r.fu || '-'}

<div class="footer">
Dr. Ashwini Srivastav
</div>

</body>
</html>`;

  const w = window.open('', '_blank');
  w.document.write(html);
  w.document.close();
  setTimeout(()=>w.print(),600);
}
</script>
</body>
</html>
